<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Racer toevoegen</title>
        <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js"></script>
        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script>
            'use strict'
            window.onload = init;
            function init(){
               for (var a of document.getElementsByTagName('a'))
                    {
                        a.addEventListener('click', function(e){
                            getNewPage(e.srcElement.getAttribute('url') || e.target.getAttribute('url'));
                        })
                    }
            };
            function getNewPage(url){
                var content = document.getElementById('content');
                var newContent = '';
                switch (url){
                    case "male":
                        loadRunner('http://localhost:8081/list/gender/man');
                        break;
                    case 'female': 
                        loadRunner('http://localhost:8081/list/gender/vrouw');
                        break;
                    case 'all':
                        loadRunner('http://localhost:8081/list');
                        break;
                    case 'new':
                        loadRunner('http://localhost:8081/pages/new.html');
                        break;
                    case 'delete':
                        var xml =new XMLHttpRequest();
                        xml.open('GET', 'http://localhost:8081/list');
                        xml.onreadystatechange = function(){
                            if (xml.status == 200 && xml.readyState == 4)
                                {
                                    var content = document.getElementById('content');
                                    content.innerHTML = '';
                                    var ul = document.createElement('ul');
                                    ul.setAttribute('id', 'ul');
                                    var runners = JSON.parse(xml.responseText);
                                    for (var child of runners)
                                        {
                                            var li = document.createElement('li');
                                            li.setAttribute('id', child._id);
                                            li.innerHTML = '<span>'+child.naam +' '+child.achternaam+'</span>';
                                            ul.appendChild(li);
                                        }
                                    content.appendChild(ul);
                                    for (var lili of document.getElementById('ul'))
                                        {
                                            lili.addEventListener('click', function(e){
                                                deleteRunner(child._id, child.naam, child.achternaam);
                                            });
                                        }
                                }
                        }
                        xml.send();
                        break;
                }
            }

            function deleteRunner(id, name, lastname){
                if (confirm('Are you sure you want to delete ' + name+' '+lastname+' ('+id+')?'))
                    {
                        var del = new XMLHttpRequest();
                        del.open('POST', 'http://localhost:8081/deleteRunner');
                        del.onreadystatechange = function(){
                            if (del.status == 200 && del.readyState == 4)
                                {
                                    alert(del.responseText);
                                }
                        }
                        del.setRequestHeader('Content-Type', 'x-www-form-urlencoded')
                        del.send('id='+id);
                    }
            }

            function loadRunner(url){
            var xml = new XMLHttpRequest();
              xml.open('GET', url);
              var states = new Array(200, 304, 201, 202);
              xml.onreadystatechange = function(){
                  if (states.indexOf(xml.status) != -1 && xml.readyState==4)
                    {
                        var content = document.getElementById('content');
                        content.innerHTML = '';
                        if (xml.getResponseHeader('Content-Type').toString().search(/text\/html/i) != -1)
                            {
                                content.innerHTML = xml.responseText;
                                content.getElementsByTagName('button')[0].addEventListener('click', newRunner);
                                //content.getElementById('btn').addEventListener('click', newRunner);
                            }
                        else if (xml.getResponseHeader('Content-Type').toString().search(/application\/json/i) != -1)
                            {
                                var runners = JSON.parse(xml.responseText);
                                var ul = document.createElement('ul');
                                ul.setAttribute('id', 'ulul');
                                for (var runner of runners)
                                    {
                                        var li = document.createElement('li');
                                        li.innerHTML = runner.naam +' '+runner.achternaam+' ('+runner.gender+') heeft de race in '+runner.uren+' en '+runner.minuten+' gelopen.';
                                        ul.appendChild(li);
                                    }
                                content.appendChild(ul);
                            }
                    }
              }  
              xml.send();
            }

            function newRunner(event)
                {
                    event.preventDefault();
                    var xml = new XMLHttpRequest();
                    xml.open('POST', 'http://localhost:8081/addRunner');
                    xml.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                    xml.onreadystatechange = function(){
                        if (xml.status == 200)
                            {
                                if (xml.readyState == 0)
                                    {
                                        var balk = document.createElement('progress');
                                        balk.setAttribute('min', 0);
                                        balk.setAttribute('max', 0);
                                        balk.setAttribute('id', 'pro');
                                        balk.setAttribute('class', 'progress-bar');
                                        document.getElementById('balk').appendChild(balk);
                                    }
                                else 
                                    {
                                        document.getElementById('id').value = xml.readyState * 25
                                        
                                    }
                                if (xml.readyState == 4){
                                        document.getElementById('btn').removeAttribute('class');
                                        document.getElementById('btn').setAttribute('class', 'btn btn-success')
                                }
                            }
                        if (xml.status == 404)
                            {
                                document.getElementById('btn').removeAttribute('class');
                                document.getElementById('btn').setAttribute('class', 'btn btn-danger')
                            }
                        if (xml.status == 500)
                            {
                                document.getElementById('btn').removeAttribute('class');
                                document.getElementById('btn').setAttribute('class', 'btn btn-error')
                            }
                    }
                    var name = document.getElementById('name').value;
                    var lastname = document.getElementById('lastname').value;
                    var hour = document.getElementById('hour').value;
                    var minutes = document.getElementById('minutes').value;
                    var gender = document.getElementById('gender').value;
                    xml.send('name='+name
                    +'&lastname='+lastname
                    +'&hour='+hour
                    +'&minutes='+minutes
                    +'&gender='+gender
                    );
                }
        </script>
    </head>
    <body>
        <div class="container-fluid text-center">
            <div class="row">
                <div class="col-sm-10 col-sm-offset-1">
                    <ul class="nav nav-tabs">
                        <li><a url="male" id="1">Male finishers</a></li>
                        <li><a url="female" id="2">Female finishers</a></li>
                        <li><a url="all" id="3">All finishers</a></li>
                        <li><a url="new" id="4" >Insert new finisher</a></li>
                        <li><a url="delete" id="5">Delete finisher</a></li>
                    </ul>
                </div>
            </div>
            <div id="content">
                
            </div>
        </div>
    </body>
</html>